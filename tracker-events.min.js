require(["jquery"], function ($) {
    (function () {
        if (typeof window.CustomEvent === "function") return false;
        function CustomEvent(event, params) {
            params = params || { bubbles: false, cancelable: false, detail: undefined };
            var evt = document.createEvent("CustomEvent");
            evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
            return evt;
        }
        CustomEvent.prototype = window.Event.prototype;
        window.CustomEvent = CustomEvent;
    })();
    var trackerObject = JSON.parse(localStorage.getItem("trackerObject"));
    var tracker_events = {
        PAGE_VISIT: "PageVisit",
        PRODUCT_VISIT: "ViewProduct",
        ADD_TO_CART: "AddToBasket",
        ADD_TO_CART_SUCCESS: "AddToBasketSuccess",
        BUY_NOW: "BuyNow",
        BUY_NOW_SUCCESS: "BuyNowSuccess",
        REMOVE_FROM_CART: "RemoveFromBasket",
        MARK_WISHLIST: "Wishlist",
        UNMARK_WISHLIST: "RemoveFromWishlist",
        CATEGORY_VISIT: "CategoryVisit",
        CATEGORY_SORT: "CategorySort",
        CATEGORY_FILTER: "CategoryFilter",
        CART_VISIT: "CartVisit",
        CART_UPDATE: "CartUpdate",
        PROCEED_TO_CHECKOUT: "CheckoutClicks",
        CART_EMAIL_ENTERED: "CheckoutFormEmailEntered",
        CART_PHONE_ENTERED: "CheckoutFormPhoneEntered",
        CHECKOUT_STEP_1: "CheckoutStep1Complete",
        CHECKOUT_STEP_2: "SubmitOrderClicks",
        ORDER_SUCCESS: "OrderSuccess",
        SEARCH_QUERY: "KeywordSearch",
        SEARCH_STATUS: "SearchResultVisit",
        CUSTOMER_LOGIN: "Login",
        CUSTOMER_SIGNUP: "Signup",
        CUSTOMER_LOGOUT: "CustomerLogout",
        COUPON_APPLY_CLICK: "CouponApply",
        COUPON_APPLY_SUCCESS: "CouponApplySuccess",
    };
    function triggerEvent(event_name, event_data, interaction_object) {
        try {
            if (Boolean(trackerObject.shoptimize.enabled)) {
                console.log(event_name, " : ", event_data);
                ShoptimizeTrackerServices.shoptimize_track(event_name, event_data, interaction_object);
            }
        } catch (err) {
            console.log(err);
        }
    }
    function getProductData(id) {
        return window.shopti_data_layer.products.filter(function (product, index) {
            if (product.id == id || product.product_id == id) {
                product.position = index + 1;
                return true;
            }
        });
    }
    function triggerProductEvent(selector, event_name) {
        var id = $(selector).closest("[data-tracker-identifier]").attr("data-tracker-identifier");
        if (!id && window.shopti_data_layer.products) {
            id = window.shopti_data_layer.products[0].id;
        }
        if (id) {
            var data = getProductData(id);
            if (data.length) {
                $.cookie("a2c_data", JSON.stringify(data[0]), { path: "/", expires: 1 });
                var product_data = {
                    products: data,
                    product_id: data[0].id ? data[0].id : data[0].product_id,
                    sku: data[0].sku,
                    name: data[0].name,
                    category_ids: [data[0].category_id],
                    category_names: [data[0].category_name],
                    stock: null,
                    product_price: data[0].discounted_price,
                    source: data[0].source,
                };
                triggerEvent(event_name, product_data, "Product");
            }
        }
    }
    function triggerSuccessEvent(event_name) {
        var product_data = JSON.parse($.cookie("cart_success_data"));
        if (product_data) {
            triggerEvent(event_name, product_data, "Product");
        }
        $.cookie("cart_success_data", null, { path: "/", expires: -1 });
        $.cookie("cart_success_status", null, { path: "/", expires: -1 });
    }
    function triggerCategoryEvent(category_data, event_name) {
        triggerEvent(event_name, category_data, "Category");
    }
    function triggerCartEvent(event_name) {
        cart_data = window.shopti_data_layer;
        triggerEvent(event_name, cart_data, "Cart");
    }
    function triggerCheckoutEvent(event_name) {
        checkout_data = window.shopti_data_layer;
        triggerEvent(event_name, checkout_data, "Cart");
    }
    function triggerSearchEvent(event, event_name) {
        if (event_name == tracker_events.SEARCH_QUERY) {
            var query = $("#search_mini_form")
                .serializeArray()
                .reduce(function (obj, item) {
                    obj[item.name] = item.value;
                    return obj;
                }, {});
            var search_data = { keyword: query.q, search_query: query.q, results_returned: null, result_count: null, query_time: null, url: null };
        }
        if (event_name == tracker_events.SEARCH_STATUS) {
            var search_data = { search_query: event.detail.query, keyword: event.detail.query, results_returned: event.detail.results_returned, result_count: event.detail.results_count, query_time: null, url: window.location.href };
        }
        triggerEvent(event_name, search_data, "Search");
    }
    function getTypeFromCookie() {
        var array = document.cookie.split(" ");
        var type = "Generic";
        array.forEach((element) => {
            if (element.indexOf("login_type") !== -1) {
                type = element.split("=")[1];
                type = type.split(";")[0];
            }
        });
        return type;
    }
    function triggerAccountEvent(event, event_name) {
        account_data = event.detail;
        account_data.type = getTypeFromCookie();
        triggerEvent(event_name, account_data, "Account");
    }
    function triggerCouponApply(status, event) {
        var coupon_data = {};
        var quote = event.detail.quote;
        try {
            coupon_data = {
                coupon: event.detail.coupon,
                cart_id: quote.totals._id,
                cart_total: quote.totals._latestValue.subtotal_with_discount,
                discount_amount: Math.abs(quote.totals._latestValue.discount_amount) ? Math.abs(quote.totals._latestValue.discount_amount) : null,
            };
        } catch (error) {
            console.log(error);
        }
        if (!status) {
            triggerEvent(tracker_events.COUPON_APPLY_CLICK, coupon_data, "Coupon");
        } else {
            triggerEvent(tracker_events.COUPON_APPLY_SUCCESS, coupon_data, "Coupon");
        }
    }
    $(document).ready(function () {
        $("button.action.tocart").click(function () {
            triggerProductEvent(this, tracker_events.ADD_TO_CART);
        });
        $("button.action.buynow").click(function () {
            triggerProductEvent(this, tracker_events.BUY_NOW);
        });
        $("a.action.towishlist").click(function () {
            triggerProductEvent(this, tracker_events.MARK_WISHLIST);
        });
        $(".actions-toolbar a.action-towishlist").click(function () {
            triggerProductEvent(this, tracker_events.MARK_WISHLIST);
        });
        $(".btn-remove.action.delete").click(function () {
            triggerProductEvent(this, tracker_events.UNMARK_WISHLIST);
        });
        $(".cart.item .action.action-delete").click(function () {
            triggerProductEvent(this, tracker_events.REMOVE_FROM_CART);
        });
        $(document).on("add_to_cart_success", function () {
            triggerSuccessEvent(tracker_events.ADD_TO_CART_SUCCESS);
        });
        $(document).on("buy_now_success", function () {
            triggerSuccessEvent(tracker_events.BUY_NOW_SUCCESS);
        });
        $(document).on("CouponApply", function (event) {
            triggerCouponApply(false, event);
        });
        $(document).on("CouponApplySuccess", function (event) {
            triggerCouponApply(true, event);
        });
        $(document).on("login", function (event) {
            triggerAccountEvent(event, tracker_events.CUSTOMER_LOGIN);
        });
        $(document).on("signup", function (event) {
            triggerAccountEvent(event, tracker_events.CUSTOMER_SIGNUP);
        });
        $(document).on("logout", function (event) {
            triggerAccountEvent(event, tracker_events.CUSTOMER_LOGOUT);
        });
        $("[data-cart-item-update]").click(function () {
            triggerCartEvent(tracker_events.CART_UPDATE);
        });
        $("[data-role='proceed-to-checkout']").click(function () {
            triggerCartEvent(tracker_events.PROCEED_TO_CHECKOUT);
        });
        $(document).on("EmailEntered", function () {
            triggerCheckoutEvent(tracker_events.CART_EMAIL_ENTERED);
        });
        $(document).on("PhoneEntered", function () {
            triggerCheckoutEvent(tracker_events.CART_PHONE_ENTERED);
        });
        $(document).on("CheckoutNext", function () {
            triggerCheckoutEvent(tracker_events.CHECKOUT_STEP_1);
        });
        $(document).on("PlaceOrder", function () {
            triggerCheckoutEvent(tracker_events.CHECKOUT_STEP_2);
        });
        $(document).on("OrderSuccess", function () {
            triggerOrderSuccess();
        });
        $("#sorter [data-role='sorter']").click(function () {
            var data = window.shopti_data_layer;
            data.is_sorted = true;
            data.condition_type = $(this).attr("data-value");
            data.condition_value = $(".action.sorter-action").attr("data-value") == "desc" ? "asc" : "desc";
            triggerCategoryEvent(data, tracker_events.CATEGORY_SORT);
        });
        $("#sorter [data-role='direction-switcher']").click(function () {
            var data = window.shopti_data_layer;
            data.is_sorted = true;
            data.condition_type = $("#sorter .active [data-role='sorter']").attr("data-value") ? $("#sorter .active [data-role='sorter']").attr("data-value") : $("#sorter option[selected='selected']").val();
            data.condition_value = $(this).attr("data-value");
            triggerCategoryEvent(data, tracker_events.CATEGORY_SORT);
        });
        $("#sorter option").click(function () {
            var data = window.shopti_data_layer;
            data.is_sorted = true;
            data.condition_type = $(this).val();
            data.condition_value = $(".action.sorter-action").attr("data-value") == "desc" ? "asc" : "desc";
            triggerCategoryEvent(data, tracker_events.CATEGORY_SORT);
        });
        $("#search_mini_form").submit(function (event) {
            triggerSearchEvent(event, tracker_events.SEARCH_QUERY);
        });
        $(document).on("searchComplete", function (event) {
            triggerSearchEvent(event, tracker_events.SEARCH_STATUS);
        });
        $("button.action.login").click(function () {
            $.cookie("login_type", "Generic", { path: "/" });
        });
        $("a.social-button").click(function () {
            var type = $(this).closest("[data-tracking-context]").attr("data-tracking-context");
            $.cookie("login_type", type, { path: "/" });
        });
    });
});
