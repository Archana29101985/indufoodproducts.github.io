require(["jquery", "tracker", "amplitude"], function ($, tracker, amplitude) {
    var trackerObject = JSON.parse(localStorage.getItem("trackerObject"));
    function pageVisit() {
        var eventProperties = { page_url: window.location.href };
        if (Boolean(trackerObject.shoptimize.enabled)) {
            ShoptimizeTrackerServices.shoptimize_track("PageVisit", eventProperties);
        }
        if (Boolean(trackerObject.amplitude.enabled)) {
            amplitude.getInstance().logEvent("PageVisit", eventProperties);
        }
        if (Boolean(trackerObject.facebook.enabled)) {
            fbq("track", "PageView");
        }
    }
    $(document).ready(function () {
        (function () {
            if (typeof window.CustomEvent === "function") return false;
            function CustomEvent(event, params) {
                params = params || { bubbles: false, cancelable: false, detail: undefined };
                var evt = document.createEvent("CustomEvent");
                evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
                return evt;
            }
            CustomEvent.prototype = window.Event.prototype;
            window.CustomEvent = CustomEvent;
        })();
    });
    function callTracker(element) {
        if ($(element.target).closest("div[data-tracking-context]").attr("data-tracking-context") != null || $(element.target).closest("data-event-properties").attr("data-event-properties")) {
            var event_name = $(element.target).closest("div[data-tracking-context]").attr("data-tracking-context"),
                event_properties = $(element.target).closest("div[data-event-properties]").attr("data-event-properties");
            var prod_quantity = $(element.target).closest('[name="qty"]').val();
            var prod_name = JSON.parse(event_properties).name ? JSON.parse(event_properties).name : $(".action.tocart.primary").closest("li.product.item").find(".product-item-link").text().trim();
            console.log(JSON.parse(event_properties));
            var custEvent = new CustomEvent(event_name, { detail: { event_properties: JSON.parse(event_properties) } });
            document.dispatchEvent(custEvent);
            if (Boolean(trackerObject.amplitude.enabled)) {
                amplitude.getInstance().logEvent(event_name, JSON.parse(event_properties));
            }
            if (Boolean(trackerObject.facebook.enabled)) {
                console.log("inside fb enabled");
                console.log(event_name);
                if (event_name == "AddToBasket") {
                    console.log(JSON.parse(event_properties));
                    fbq("track", "AddToCart", { content_name: JSON.parse(event_properties).sku, content_ids: [JSON.parse(event_properties).sku], content_type: "product", value: JSON.parse(event_properties).product_price, currency: "INR" });
                }
                if (event_name == "Wishlist") {
                    console.log(JSON.parse(event_properties));
                    fbq("track", "AddToWishlist", {
                        content_name: JSON.parse(event_properties).sku,
                        content_ids: [JSON.parse(event_properties).sku],
                        content_type: "product",
                        value: JSON.parse(event_properties).product_price,
                        currency: "INR",
                    });
                }
                if (event_name == "CheckoutClicks") {
                    console.log("Checkout Clicks event called");
                    console.log(event_properties);
                    var pids = JSON.parse(event_properties).content_ids;
                    var arrpids = pids.split(",");
                    var content_ids_str = "";
                    for (var i = 0; i < arrpids.length; i++) {
                        if (content_ids_str === "") content_ids_str = "['" + arrpids[i] + "'";
                        else content_ids_str += ",'" + arrpids[i] + "'";
                    }
                    if (content_ids_str != "") content_ids_str += "]";
                    console.log(content_ids_str);
                    fbq("track", "InitiateCheckout", {
                        content_name: "checkout",
                        content_ids: content_ids_str,
                        content_type: "product",
                        num_items: JSON.parse(event_properties).num_items,
                        value: JSON.parse(event_properties).cart_value,
                        currency: "INR",
                    });
                }
            }
            if (Boolean(trackerObject.google_adwords.remarketing.enabled)) {
                if (event_name == "AddToBasket") {
                    gtag("event", "add_to_cart", { items: [{ name: prod_name, id: JSON.parse(event_properties).sku, price: JSON.parse(event_properties).product_price, quantity: prod_quantity ? prod_quantity : 1 }] });
                }
                if (event_name == "CheckoutClicks") {
                    gtag_event_data = { value: window.shopti_data_layer.cart_value.toString(), items: [] };
                    window.shopti_data_layer.products.forEach(function (product) {
                        var prod = { id: product.sku, name: product.name, price: product.discounted_price.toString(), quantity: product.quantity, google_business_vertical: "retail" };
                        gtag_event_data.items.push(prod);
                    });
                    gtag("event", "begin_checkout", gtag_event_data);
                }
            }
        } else {
        }
    }
    $(document).click(function (element) {
        callTracker(element);
    });
});
